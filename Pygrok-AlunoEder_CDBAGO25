
#!pip install streamlit pyngrok

# 2¬∫ passo
# %%writefile cria um arquivo Python chamado 'app.py' com todo o c√≥digo desta c√©lula.
# Isso √© necess√°rio no Colab porque o Streamlit e o ngrok precisam de um arquivo f√≠sico
# para rodar o app. Sem isso, os gr√°ficos e a interface n√£o seriam exibidos pelo t√∫nel ngrok.



# ===============================
# Importa√ß√£o das bibliotecas
# ===============================
import os
import pandas as pd
import plotly.express as px
import streamlit as st
from pyngrok import ngrok

# =================================================================

# Caminho simples (mesmo diret√≥rio do Colab)
arquivo = 'consultas.csv'

# Verifica se o arquivo existe antes de ler
if not os.path.exists(arquivo):
    st.error(f"Arquivo '{arquivo}' n√£o encontrado. Envie o arquivo e recarregue o app.")
    st.stop()

# L√™ o CSV
df = pd.read_csv(arquivo, parse_dates=['dataconsulta'])

# ===============================
# Configura√ß√£o e exibi√ß√£o no Streamlit
# ===============================
st.set_page_config(page_title='Painel de Consultas M√©dicas', layout='wide')

# Combo das datas
data_unicas = sorted(df['dataconsulta'].dt.strftime('%d-%m-%y').unique())
opcao_data = st.sidebar.selectbox('Selecione a Data:', options=['Todas'] + data_unicas)

# Combo das unidades
unidade = sorted(df['unidade'].unique())
opcao_unidade = st.sidebar.selectbox('Selecione a Unidade:', options=['Todas'] + unidade)

# Faz uma c√≥pia do DataFrame original
df_filtrado = df.copy()

# Filtro por data
if opcao_data != 'Todas':
    df_filtrado = df_filtrado[df_filtrado['dataconsulta'].dt.strftime('%d-%m-%y') == opcao_data]

# Filtro por unidade
if opcao_unidade != 'Todas':
    df_filtrado = df_filtrado[df_filtrado['unidade'] == opcao_unidade]

# ===============================
# Gr√°ficos
# ===============================
st.title('üìä Painel de Consultas M√©dicas')

# cria√ß√£o das colunas

col1, col2, col3 = st.columns(3)


# Gr√°fico 1 - Consultas por unidade - cria√ß√£o do filtro
consultas_unidade = df_filtrado.groupby('unidade').size().reset_index(name='Total')

# Cria√ß√£o do gr√°fico
fig1 = px.bar(consultas_unidade, x='unidade', y='Total', color='unidade',
              title=f'ü©∫ Consultas por Unidade ({opcao_data})', text='Total')
fig1.update_layout(xaxis_title='Unidade', yaxis_title='Total de Consultas')

# Visualiza√ß√£o do gr√°fico
col1.plotly_chart(fig1, use_container_width=True)

# Gr√°fico 2 - Consultas por especialidade - cria√ß√£o do filtro
consultas_tipo = df_filtrado.groupby('tipoconsulta').size().reset_index(name='Total')

# Cria√ß√£o do gr√°fico
fig2 = px.pie(consultas_tipo, values='Total', names='tipoconsulta',
              title='üë®‚Äç‚öïÔ∏è Consultas por Especialidade', hole=0.4)

# Visualiza√ß√£o do gr√°fico
col2.plotly_chart(fig2, use_container_width=True)

# Gr√°fico 3 - Faturamento por unidade - cria√ß√£o do filtro
faturamento_unidade = df_filtrado.groupby('unidade', as_index=False)['valor'].sum()

# Cria√ß√£o do gr√°fico
fig3 = px.bar(faturamento_unidade, x='unidade', y='valor', color='unidade',
              title='ü•á Faturamento Total por Unidade',
              text=faturamento_unidade['valor'].map('R$ {:,.2f}'.format))
fig3.update_layout(xaxis_title='Unidade', yaxis_title='Total de Faturamento')

# Visualiza√ß√£o do gr√°fico
col3.plotly_chart(fig3, use_container_width=True)

# Tabela de registros
st.subheader(f'üìã Registros: ({opcao_unidade})')
st.dataframe(df_filtrado, use_container_width=True)
